<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>å…¨çƒè§†ç•Œ - èšåˆæ–°é—»</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<!-- å¯¼èˆªæ  -->
<header>
    <div class="container nav-wrapper">
        <a href="/" class="logo">DailyNews</a>
        <div class="nav-links">
            <a th:classappend="${currentCategory == 'education'} ? 'active' : ''" onclick="trackAndGo('education')" class="nav-item">æ•™è‚²</a>
            <a th:classappend="${currentCategory == 'entertainment'} ? 'active' : ''" onclick="trackAndGo('entertainment')" class="nav-item">å¨±ä¹</a>
            <a th:classappend="${currentCategory == 'games'} ? 'active' : ''" onclick="trackAndGo('games')" class="nav-item">æ¸¸æˆ</a>
            <a th:classappend="${currentCategory == 'health'} ? 'active' : ''" onclick="trackAndGo('health')" class="nav-item">å¥åº·</a>
            <a th:classappend="${currentCategory == 'tech'} ? 'active' : ''" onclick="trackAndGo('tech')" class="nav-item">ç§‘æŠ€</a>
        </div>

        <form action="/" method="get" class="search-box">
            <input type="text" name="keyword" placeholder="æœç´¢æ–°é—»..." th:value="${currentKeyword}">
            <button type="submit" class="search-btn">ğŸ”</button>
        </form>
    </div>
</header>

<div class="container main-layout">
    <!-- æ–°é—»åˆ—è¡¨ -->
    <div class="news-list">
        <div th:if="${#lists.isEmpty(newsList)}" style="text-align:center; color:#999; margin-top:50px;">
            æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–°é—»
        </div>

        <div th:each="news : ${newsList}" class="news-card">
            <div style="flex:1">
                <a th:href="@{/news/{id}(id=${news.id})}" class="news-title" th:text="${news.title}"></a>
                <div class="news-meta">
                    <span th:class="'tag tag-' + ${news.category}" th:text="${news.category}"></span>
                    <span th:text="${#dates.format(news.createTime, 'yyyy-MM-dd HH:mm')}"></span>
                </div>
            </div>
            <div style="color:#ddd;"> &gt; </div>
        </div>
    </div>

    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
        <div class="ad-card">
            <h4 id="ad-title">çŒœä½ å–œæ¬¢</h4>
            <div id="ad-content-area">åŠ è½½ä¸­...</div>
            <div style="font-size:12px; color:#aaa; margin-top:15px;">ç”¨æˆ·ID: <span id="uuid-display"></span></div>
        </div>
    </aside>
</div>

<script>
    let uuid = localStorage.getItem('user_uuid');
    if (!uuid) {
        uuid = 'user_' + Math.random().toString(36).substring(2);
        localStorage.setItem('user_uuid', uuid);
    }
    document.getElementById('uuid-display').innerText = uuid;

    function trackAndGo(category) {
        fetch('/api/track', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ uuid: uuid, category: category })
        }).finally(() => {
            window.location.href = '/?category=' + category;
        });
    }

    fetch('/api/ad/recommend?uuid=' + uuid)
        .then(res => res.json())
        .then(ad => {
            const area = document.getElementById('ad-content-area');
            const titleElem = document.getElementById('ad-title');

            // 1. è®¾ç½®æ ‡é¢˜
            titleElem.innerText = ad.title || 'æ¨èå†…å®¹';

            // 2. è·å–åŸå§‹ URL
            let rawUrl = ad.media_url || ad.mediaUrl;

            // ==================================================
            // ğŸš‘ ç´§æ€¥ä¿®å¤ï¼šå¼ºè¡Œç»™æœ‹å‹çš„ URL åŠ ä¸Š 8080 ç«¯å£
            // ==================================================
            let mediaUrl = "";
            if (rawUrl) {
                // å¦‚æœ URL é‡ŒåŒ…å«è¿™ä¸ª IPï¼Œä¸”åé¢ç´§è·Ÿçš„æ˜¯ / (è¯´æ˜æ²¡å¸¦ç«¯å£)
                // å°±æŠŠå®ƒæ›¿æ¢æˆå¸¦ :8080 çš„
                mediaUrl = rawUrl.replace('175.24.232.219/', '175.24.232.219:8080/');

                console.log("ä¿®å¤åçš„å›¾ç‰‡åœ°å€:", mediaUrl); // æ–¹ä¾¿åœ¨æ§åˆ¶å°ç¡®è®¤
            }

            const targetUrl = ad.target_url || ad.targetUrl || '#';

            if (!mediaUrl) {
                area.innerHTML = '<p>æš‚æ— å¹¿å‘Šå›¾ç‰‡</p>';
                return;
            }

            // 3. æ¸²æŸ“ HTML (ä¿æŒä¹‹å‰çš„ä¼˜åŒ–ï¼šé˜²ç›—é“¾ + ç‚¹å‡»è·³è½¬)
            let htmlContent = '';

            if (ad.type === 'video') {
                htmlContent = `
                    <div style="position: relative;">
                        <video src="${mediaUrl}" controls autoplay muted style="width:100%; border-radius:5px;"></video>
                        <div style="margin-top:5px;">
                            <a href="${targetUrl}" target="_blank" class="btn btn-primary" style="display:block; text-align:center; font-size:12px; padding:5px;">
                                ç‚¹å‡»äº†è§£è¯¦æƒ… &gt;
                            </a>
                        </div>
                    </div>
                `;
            } else {
                htmlContent = `
                    <a href="${targetUrl}" target="_blank" style="display:block; cursor:pointer;">
                        <img src="${mediaUrl}"
                             referrerpolicy="no-referrer"
                             alt="${ad.title}"
                             style="width:100%; border-radius:5px; transition: opacity 0.2s; min-height: 150px; background: #f0f0f0;"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x200?text=Load+Error';">
                    </a>
                `;
            }

            area.innerHTML = htmlContent;
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            document.getElementById('ad-content-area').innerHTML = "åŠ è½½æ¨èå¤±è´¥";
        });
</script>
</body>
</html>